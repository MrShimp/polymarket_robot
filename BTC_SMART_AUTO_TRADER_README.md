# BTC 智能自动交易器

## 概述

`btc_smart_auto_trader.py` 是一个智能的BTC 15分钟自动交易器，它会根据启动时间智能决定参与哪个市场：

- **如果距离上一个15分钟整点小于5分钟**：直接获取并参与上一个15分钟的市场
- **如果距离上一个15分钟整点超过5分钟**：等待并参与下一个市场

## 主要特性

### 🧠 智能时间判断
- 启动时自动分析当前时间与15分钟整点的关系
- 根据5分钟阈值智能选择参与上一个或下一个市场
- 避免错过交易机会，提高市场参与效率

### ⏰ 时间计算逻辑
- 获取当前北京时间
- 计算上一个和下一个15分钟整点
- 转换为美东时间戳用于市场查询
- 精确计算时间间隔进行决策

### 🎯 市场获取策略
- 根据时间戳直接查询特定的BTC 15分钟市场
- 验证市场可用性（未关闭、接受订单、有效token）
- 自动处理市场不可用的情况

### 🔄 持续监控
- 监控策略进程运行状态
- 策略结束后自动启动新的交易周期
- 异常处理和自动重试机制

## 使用方法

### 基本启动
```bash
python btc_smart_auto_trader.py
```

### 指定交易金额
```bash
python btc_smart_auto_trader.py 10.0
```

## 工作流程

### 1. 启动分析
```
🤖 BTC智能自动交易器初始化完成
💰 交易金额: $5.0
⏰ 时间阈值: 5分钟

⏰ 时间分析:
   上一个15分钟整点: 14:45 (时间戳: 1737799500)
   下一个15分钟整点: 15:00 (时间戳: 1737800400)
   距离上一个整点: 2.3分钟
   距离下一个整点: 12.7分钟
```

### 2. 决策过程

#### 情况A：间隔小于5分钟
```
🎯 决策: 参与上一个市场 (间隔2.3分钟 <= 5分钟)
🔍 查询市场: https://gamma-api.polymarket.com/markets/slug/btc-updown-15m-1737799500
✅ 找到可用市场: Will BTC be above $95,000 at 2:45 PM ET?
🎯 立即参与市场: 参与上一个市场 (间隔2.3分钟)
```

#### 情况B：间隔超过5分钟
```
⏳ 决策: 等待下一个市场 (间隔7.8分钟 > 5分钟)
⏰ 等待下一个市场，还需 4.2分钟
⏰ 下一个市场即将开始
✅ 找到可用市场: Will BTC be above $95,000 at 3:00 PM ET?
🎯 参与下一个市场
```

### 3. 策略执行
```
🚀 启动交易策略
   市场ID: 0x1234567890abcdef
   BTC价格: $95,234.56
   交易金额: $5.0
✅ 策略进程已启动 (PID: 12345)
```

### 4. 持续监控
```
📊 策略正在运行中...
✅ 策略正常结束
🔄 策略已结束，准备启动新的交易周期
```

## 与原版的区别

| 特性 | 原版 btc_auto_trader.py | 新版 btc_smart_auto_trader.py |
|------|-------------------------|-------------------------------|
| 启动方式 | 等待下一个15分钟整点 | 智能判断参与上一个或下一个市场 |
| 时间效率 | 可能错过刚开始的市场 | 最大化市场参与机会 |
| 市场获取 | 通过test_trading_bot.py获取 | 直接根据时间戳查询特定市场 |
| 决策逻辑 | 固定等待模式 | 基于5分钟阈值的智能决策 |
| 适用场景 | 定时启动 | 随时启动，智能适应 |

## 配置参数

### 时间阈值
```python
self.time_threshold = 5  # 5分钟阈值，可根据需要调整
```

### 交易参数
- 默认交易金额：$5.0
- 支持命令行参数指定金额
- 使用相同的btc_15min_strategy.py策略

## 日志文件

日志保存在 `data/auto_trader_logs/smart_auto_trader_YYYYMMDD_HHMMSS.log`

## 注意事项

1. **市场可用性**：如果目标市场不可用，会自动切换到备选方案
2. **网络依赖**：需要稳定的网络连接查询市场和价格
3. **策略依赖**：依赖 `btc_15min_strategy.py` 文件执行具体交易策略
4. **时区处理**：自动处理北京时间和美东时间的转换

## 错误处理

- 网络请求失败自动重试
- 市场查询失败切换备选方案
- 策略进程异常自动重启
- 完整的错误日志记录

## 停止程序

使用 `Ctrl+C` 安全停止程序，会自动清理运行中的策略进程。